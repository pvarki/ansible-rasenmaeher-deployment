---
- name: Deploy Docker Compose from repository
  when: deployment_source == 'remote'
  block:
  - name: Ensure git is installed (Debian/Ubuntu)
    ansible.builtin.apt:
      name: git
      state: present
    when: ansible_os_family == "Debian"

  - name: Clone Docker Compose project repository
    ansible.builtin.git:
      repo: "{{ docker_composition_repo }}"
      dest: "/home/{{ ansible_env.SUDO_USER }}/docker-rasenmaeher-integration"
      version: "{{ docker_repo_tag }}"
      depth: 1
      clone: yes
      update: no  # Do not update submodules yet

  - name: Switch .gitmodules ssh repos to https
    ansible.builtin.replace:
      path: "/home/{{ ansible_env.SUDO_USER }}/docker-rasenmaeher-integration/.gitmodules"
      regexp: 'git@github.com:'
      replace: 'https://github.com:'

  - name: Deploy Docker Compose project
    community.general.docker_compose:
      project_src: "/home/{{ ansible_env.SUDO_USER }}/docker-rasenmaeher-integration"
      state: present
      pull: yes
      restarted: yes
    environment:
      KEYCLOAK_DATABASE_PASSWORD: "{{ keycloak_database_password }}"
      RM_DATABASE_PASSWORD: "{{ rm_database_password }}"
      POSTGRES_PASSWORD: "{{ postgres_password }}"
      LDAP_ADMIN_PASSWORD: "{{ ldap_admin_password }}"
      KEYCLOAK_ADMIN_PASSWORD: "{{ keycloak_admin_password }}"
      KEYCLOAK_MANAGEMENT_PASSWORD: "{{ keycloak_management_password }}"
      TAK_DATABASE_PASSWORD: "{{ tak_database_password }}"
      SERVER_DOMAIN: "{{ server_domain }}"
      CFSSL_CA_NAME: "{{ cfssl_ca_name }}"
      MW_LE_EMAIL: "{{ mw_le_email }}"
      MW_LE_TEST: "{{ mw_le_test }}"
      TAKSERVER_CERT_PASS: "{{ takserver_cert_pass }}"
      TAK_CA_PASS: "{{ tak_ca_pass }}"
    become: no
